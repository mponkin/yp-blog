<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Blog Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .line-clamp-3 {
            display: -webkit-box;
            line-clamp: 3;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
            <a href="#" onclick="showPosts(); return false;" class="text-xl font-bold tracking-tight text-blue-600">
                WASM.Blog
            </a>
            <div id="nav-auth" class="flex items-center gap-4"></div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <div id="app-viewport"></div>
    </main>

    <script type="module">
        import init, { BlogApp } from './pkg/blog_wasm.js';

        let app;
        const viewport = document.getElementById('app-viewport');
        const navAuth = document.getElementById('nav-auth');
        const PAGE_LIMIT = 5n; 

        async function start() {
            await init();
            app = new BlogApp("http://127.0.0.1:8080/api"); 
            updateUI();
        }

        function updateUI() {
            renderNav();
            showPosts();
        }

        const formatDate = (dateStr) => {
            const d = new Date(dateStr);
            const pad = (n) => n.toString().padStart(2, '0');
            return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };

        const renderDates = (created, updated) => {
            const c = formatDate(created);
            const u = formatDate(updated);
            let html = `<span class="text-slate-400">Опубликовано: ${c}</span>`;
            if (created !== updated) {
                html += `<span class="text-slate-400 ml-3 italic">(ред. ${u})</span>`;
            }
            return html;
        };

        function renderNav() {
            if (app.is_authenticated()) {
                navAuth.innerHTML = `
                    <span class="text-sm text-slate-500 italic">Авторизован</span>
                    <button onclick="handleLogout()" class="text-sm font-medium text-red-500 hover:text-red-700">Выйти</button>
                `;
            } else {
                navAuth.innerHTML = `
                    <button onclick="showLogin()" class="text-sm font-medium text-slate-600 hover:text-blue-600">Войти</button>
                    <button onclick="showRegister()" class="text-sm bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Регистрация</button>
                `;
            }
        }

        // --- СПИСОК ПОСТОВ С ПАГИНАЦИЕЙ ---
        window.showPosts = async (offset = 0n) => {
            viewport.innerHTML = '<div class="flex justify-center py-12"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';
            
            try {
                const data = await app.load_posts(BigInt(offset), PAGE_LIMIT);
                const posts = data.posts;
                const total = BigInt(data.total_posts);
                const currentOffset = BigInt(data.offset);
                const limit = BigInt(data.limit);

                let html = '';
                if (app.is_authenticated()) {
                    html += `
                        <button onclick="showCreatePost()" class="w-full mb-8 py-6 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all flex items-center justify-center gap-2 font-medium">
                            + Написать новый пост
                        </button>`;
                }

                html += `<div class="grid gap-6">`;
                posts.forEach(post => {
                    const isOwner = app.post_belongs_to_current_user(BigInt(post.author_id));
                    html += `
                        <article class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex justify-between gap-4">
                            <div class="flex-1 cursor-pointer group" onclick="viewPost('${post.id}')">
                                <h3 class="text-xl font-bold group-hover:text-blue-600 transition-colors mb-2">${post.title}</h3>
                                <div class="text-[11px] mb-3 flex flex-wrap font-medium uppercase tracking-wider">
                                    ${renderDates(post.created_at, post.updated_at)}
                                </div>
                                <p class="text-slate-600 line-clamp-3 leading-relaxed">${post.content}</p>
                            </div>
                            ${isOwner ? `
                                <div class="flex flex-col gap-2 shrink-0">
                                    <button onclick="editPost('${post.id}')" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                    </button>
                                    <button onclick="confirmDelete('${post.id}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            ` : ''}
                        </article>
                    `;
                });
                html += `</div>`;
                
                // Пагинация
                const hasNext = (currentOffset + limit) < total;
                const hasPrev = currentOffset > 0n;
                if (hasNext || hasPrev) {
                    html += `
                        <div class="mt-12 flex items-center justify-center gap-4">
                            <button ${!hasPrev ? 'disabled' : ''} onclick="showPosts(${currentOffset - limit}n)" class="px-6 py-2 rounded-full font-medium transition ${!hasPrev ? 'text-slate-300 cursor-not-allowed' : 'bg-white border hover:bg-slate-50 shadow-sm'}">&larr; Назад</button>
                            <span class="text-sm text-slate-500 font-medium">${currentOffset / limit + 1n} из ${total === 0n ? 1n : (total + limit - 1n) / limit}</span>
                            <button ${!hasNext ? 'disabled' : ''} onclick="showPosts(${currentOffset + limit}n)" class="px-6 py-2 rounded-full font-medium transition ${!hasNext ? 'text-slate-300 cursor-not-allowed' : 'bg-white border hover:bg-slate-50 shadow-sm'}">Вперед &rarr;</button>
                        </div>`;
                }

                viewport.innerHTML = html;
                window.scrollTo(0, 0);
            } catch (e) {
                viewport.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-lg">Ошибка: ${e}</div>`;
            }
        };

        // --- ДЕТАЛЬНЫЙ ПРОСМОТР ---
        window.viewPost = async (id) => {
            viewport.innerHTML = '<div class="flex justify-center py-12">...</div>';
            try {
                const post = await app.get_post(BigInt(id));
                const isOwner = app.post_belongs_to_current_user(BigInt(post.author_id));
                viewport.innerHTML = `
                    <div class="max-w-3xl mx-auto">
                        <button onclick="showPosts()" class="mb-6 flex items-center text-slate-500 hover:text-blue-600 transition">&larr; Назад</button>
                        <article class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                            <div class="mb-6">
                                <h1 class="text-3xl font-bold text-slate-900 mb-2">${post.title}</h1>
                                <div class="text-sm border-b border-slate-50 pb-4">
                                    ${renderDates(post.created_at, post.updated_at)}
                                </div>
                            </div>
                            <p class="text-slate-700 leading-relaxed whitespace-pre-wrap text-lg">${post.content}</p>
                            <div class="mt-10 pt-6 border-t border-slate-100 text-xs text-slate-400">
                                Автор ID: ${post.author_id}
                            </div>
                        </article>
                    </div>`;
            } catch (e) { alert(e); showPosts(); }
        };

        // --- РЕДАКТИРОВАНИЕ ---
        window.editPost = async (id) => {
            try {
                const post = await app.get_post(BigInt(id));
                viewport.innerHTML = `
                    <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-lg border border-slate-100">
                        <h2 class="text-2xl font-bold mb-6">Редактирование</h2>
                        <div class="space-y-4">
                            <input id="edit-title" type="text" value="${post.title}" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                            <textarea id="edit-content" rows="10" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">${post.content}</textarea>
                            <div class="flex gap-4"><button onclick="handleUpdatePost('${id}')" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold">Сохранить</button><button onclick="viewPost('${id}')" class="px-6 py-2.5 bg-slate-100 rounded-lg">Отмена</button></div>
                        </div>
                    </div>`;
            } catch (e) { alert(e); }
        };

        window.handleUpdatePost = async (id) => {
            try {
                await app.update_post(BigInt(id), document.getElementById('edit-title').value, document.getElementById('edit-content').value);
                viewPost(id);
            } catch (e) { alert(e); }
        };

        // --- ОСТАЛЬНЫЕ ОБРАБОТЧИКИ ---
        window.showLogin = () => { /* Код формы входа (был выше) */ 
            viewport.innerHTML = `<div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-100"><h2 class="text-2xl font-bold mb-6 text-center">Вход</h2><div class="space-y-4"><input id="l-user" type="text" placeholder="Username" class="w-full px-4 py-2 border rounded-lg"><input id="l-pass" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg"><button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700">Войти</button></div></div>`;
        };

        window.showRegister = () => {
            viewport.innerHTML = `<div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-100"><h2 class="text-2xl font-bold mb-6 text-center">Регистрация</h2><div class="space-y-4"><input id="r-user" type="text" placeholder="Username" class="w-full px-4 py-2 border rounded-lg"><input id="r-email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg"><input id="r-pass" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg"><button onclick="handleRegister()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700 transition">Создать аккаунт</button></div></div>`;
        };

        window.showCreatePost = () => {
            viewport.innerHTML = `<div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-lg"><h2 class="text-2xl font-bold mb-6">Новый пост</h2><div class="space-y-4"><input id="p-title" type="text" placeholder="Заголовок" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"><textarea id="p-content" rows="8" placeholder="Текст..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></textarea><div class="flex gap-4"><button onclick="handleCreatePost()" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold">Опубликовать</button><button onclick="showPosts()" class="px-6 py-2 bg-slate-100 rounded-lg">Отмена</button></div></div></div>`;
        };

        window.handleLogin = async () => { try { await app.login(document.getElementById('l-user').value, document.getElementById('l-pass').value); updateUI(); } catch (e) { alert(e); } };
        window.handleRegister = async () => { try { await app.register(document.getElementById('r-user').value, document.getElementById('r-email').value, document.getElementById('r-pass').value); updateUI(); } catch (e) { alert(e); } };
        window.handleLogout = async () => { await app.logout(); updateUI(); };
        window.handleCreatePost = async () => { try { await app.create_post(document.getElementById('p-title').value, document.getElementById('p-content').value); showPosts(); } catch (e) { alert(e); } };
        window.confirmDelete = async (id) => { if (confirm("Удалить?")) { try { await app.delete_post(BigInt(id)); showPosts(); } catch (e) { alert(e); } } };

        start();
    </script>
</body>
</html>